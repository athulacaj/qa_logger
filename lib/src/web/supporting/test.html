<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>

  <!-- json formator -->
  <script src="https://cdn.jsdelivr.net/npm/json-formatter-js@2.3.4/dist/json-formatter.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/json-formatter-js@2.3.4/dist/json-formatter.min.css" rel="stylesheet">


  <link rel="stylesheet" href="./_support.css">

  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

<body>
  <style>
    /* color palette: https://colorhunt.co/palette/252b484450695b9a8bf7e987 */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box !important;
}

html {
    width: 100%;
    height: 100%;
    font-size: 16px;
    /* define variables */
    --background-color: #1B1B1F;
    --text-color:#C7C6CA !important;
    --border-color: #444750;
    --box-border-value: 2px solid #444750;
    --box-radius: 12px;
}

body {
    width: 100%;
    height: 100vh;
    overflow: hidden;
    font-family: 'Roboto', sans-serif;
    font-size: 14px;
}

.body-container {
    background-color: var(--background-color);
    width: 100%;
    height: 100%;
    color: var(--text-color);
}

/* ----------- content ----------- */
.content {
    display: flex;
    width: 100%;
    height: 100%;
    padding: 10px 0;
}

.content_left {
    display: flex;
    overflow: hidden;
}

.content_left_main {
    /* background-color: #252B48; */
    width: 100%;
    overflow: auto;
}

.content_dragger {
    height: 100%;
    min-width: 14px;
    margin: auto;
    cursor: ew-resize;
    display: flex;
    justify-content: center;
    align-items: center;
}

.content_left_main,
.content_right {
    /* lioght white border */
    border: var(--box-border-value);
    border-radius: var(--box-radius);
}

.content-right{
    overflow: hidden;
    height: 100%;

}


@media screen and (max-width: 768px) {
    .content_right {
        display: none;
    }

}

/* ----------- content ----------- */

/* ----------- table -------------- */
.my_table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border-bottom: var(--box-border-value);
}

/* .my_table>tbody>tr {
    max-height: 30px;
} */

.my_table>tbody>tr:nth-child(odd) {
    background-color: #303033;
}

.my_table_th_tr>th {
    position: sticky;
    top: 0;
}

.my_table_th_tr>th,
.my_table_th_tr>td,
.api_row>td {
    padding: 10px 10px;
    border-right: 2px solid #444750;
    /* Vertical border */
}

th {
    position: sticky;
    top: 0;
    background-color: var(--background-color);
}

.my_table>tbody>tr>td {
    text-align: end;
    padding: 8px 10px;
}

.my_table>tbody>tr>td:nth-child(1) {
    text-align: start;
}

.my_table>tbody>tr>td:nth-child(2) {
    max-lines: 1;
    white-space: nowrap;
    overflow: auto;
    max-width: 300px;
    cursor: all-scroll;
    text-align: start;
}

.my_table>tbody>tr>td:nth-child(2)::-webkit-scrollbar {
    /* Hide the scrollbar for WebKit browsers */
    display: none;
}

.content_left_main::-webkit-scrollbar {
    width: 10px;
    height: 10px;
    background-color: var(--background-color);
}

.content_left_main::-webkit-scrollbar-thumb {
    background-color: #ffffff99;
    border-radius: 10px;
}

.content_left_main::-webkit-scrollbar-track {
    border-radius: 5px;
    width: 6px;
}


/* ----------- table -------------- */

/* ----------- tab -------------- */

.tabs-container {
    display: flex;
    justify-content: start;
    color: var(--text-color);
}

.tab {
    cursor: pointer;
    padding: 14px;
    transition: background-color 0.3s;
}

.tab>span.active {
    padding-bottom: 10px;
    border-bottom: 3px solid #ccc;
}

.tab:hover {
    background-color: #29292D;
}

.tab-view {
    border-top: 1px solid #333;
    padding: 14px;
    overflow: auto;
    height: calc(100% - 50px);
}

.tab-content {
    display: none;
}


.tab-content.active {
    display: block;
}

/* ----------- tab -------------- */

/* -------- right side contents --------- */
.overview_view_table_td {
    min-width: 100px;
    padding: 4px;
    vertical-align:top;
    word-break: break-all;
}

/* -------- right side contents --------- */
.accordion-without-theme{
    color:var(--text-color) !important;
    background-color:transparent !important;
}


::-webkit-scrollbar {
    width: 10px;
    height: 10px;
    background-color: var(--background-color);
}

::-webkit-scrollbar-thumb {
    background-color: #ffffff99;
    border-radius: 10px;
}
::-webkit-scrollbar-track {
    border-radius: 5px;
    width: 6px;
}


/* json beauify */
.json-formatter-dark.json-formatter-row .json-formatter-string, .json-formatter-dark.json-formatter-row .json-formatter-stringifiable{
    /* color: #D68D72 !important; */
    color: #d68d72e7 !important;
}

.json-formatter-constructor-name{
    color: #919094 !important;
}
.json-formatter-dark.json-formatter-row .json-formatter-key{
    color: #C586C0 !important;
}

/* ---- cyrl copy --------- */

.copy-container-class {
    /* width: 300px; */
    padding: 10px;
    padding-top: 36px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    overflow: hidden;
    position: relative;
    display: none;
  }

  .copy-button{
    position: absolute;
    top: 0;
    right: 0;
    cursor: pointer;
    /* background-color: #4CAF50; */
    /* color: #fff; */
    border: none;
    padding: 3px 20px;
    border-radius: 5px;
    background-color: #333;
    color: #fff;
  }
  .copy-button:hover{
    background-color:#919094;
  }
  .curl_box{
    padding: 4px 10px;
    word-break: break-all;
  }

  table{
    color: var(--text-color);
  }

  .my-model,.modal-content{
    color: var(--text-color);
  }
  .modal-content{
    height: 100%;
  }
  </style>
  <div class="container-fluid body-container">
    <div id="notification" style="display:none;position: absolute;z-index: 1000;width: 100%;" class="alert alert-info" role="alert" data-bs-theme="dark">
      <button type="button" style="margin-left:auto;padding:0px 10px 2px 10px;display: inline;" 
      onclick="closeNotification()" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
      <span>Open this URL on devices connected to the same network:  </span>
      <span id="ip_address" style="margin-left: 10px; color: #fff;"></span>
    </div>
    <div class="content">
      <div class="content_left">
        <div class="content_left_main" id="api-list-box">
          <!-- content for this -->
          <table class="my_table">
            <thead class="">
              <tr class="my_table_th_tr">
                <th scope="col">Method</th>
                <th scope="col">uri</th>
                <th scope="col">Status</th>
                <th scope="col">Duration</th>
                <th scope="col">Timestamp</th>
                <!-- Add more columns as needed -->
              </tr>
            </thead>
            <tbody id="api_body" class="my_table_body">
              <!-- <tr>
                <td>GET</td>
                <td>https://stage.medisensehealthcare.com:3007/api/v1/customer/610/language?is_home=false</td>
                <td>200</td>
                <td>366 ms</td>
                <td>11.28.38.134</td>
              </tr> -->
              <!-- Add more rows as needed -->
            </tbody>
          </table>
          <!-- end of content -->
        </div>
        <div class="content_dragger">||</div>
      </div>
      <div id="content_right_id" class="content_right">
        <!-- content -->
        <!-- tab -->
        <div class="tabs-container">
          <div class="tab" onclick="showTab(0)"><span class="active">Overview</span></div>
          <div class="tab" onclick="showTab(1)"><span>Headers</span></div>
          <div class="tab" onclick="showTab(2)"><span>Request</span></div>
          <div class="tab" onclick="showTab(3)"><span>Response</span></div>
        </div>
        <div class="tab-view">
          <div id="tab1" class="tab-content active">
            <table style="border: none;" id="overview_table">

            </table>
            <br />
            <div id="copy-container" class="copy-container-class" style="position:relative;">
              <!-- Your text goes here -->
              <samp id="curl_text" class="curl_box"></samp>
              <button class="copy-button" title="" data-original-title="Copy to clipboard"
                onclick="copyToClipboard('curl_text')">Copy</button>
            </div>
          </div>


          <div id="tab2" class="tab-content">
            <div class="accordion" id="accordionExample" data-bs-theme="dark">
              <div class="accordion-item accordion-without-theme">
                <h2 class="accordion-header accordion-without-theme">
                  <button class="accordion-button accordion-without-theme" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                    Response Headers
                  </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                  <div id="response-header-body" class="accordion-body">
                  </div>
                </div>
              </div>
              <div class="accordion-item accordion-without-theme">
                <h2 class="accordion-header accordion-without-theme">
                  <button class="accordion-button collapsed accordion-without-theme" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false"
                    aria-controls="collapseTwo">
                    Request Headers
                  </button>
                </h2>
                <div id="collapseTwo" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">
                  <div id="request-header-body" class="accordion-body">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="tab3" class="tab-content">

          </div>
          <div id="tab4" class="tab-content">

          </div>
        </div>
        <!-- tab -->


      </div>
    </div>
  </div>
  <!-- modal -->
  <div id="myModal" class="modal fade bd-example-modal-lg " data-bs-theme="dark" tabindex="-1" role="dialog"
    aria-labelledby="myLargeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" id="modal-content-id">
        <div class="modal-header" style="padding: 5px;">
          <button type="button" style="margin-left:auto;padding:0px 10px 2px 10px;" onclick="closeModal()" class="close"
            data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

      </div>
    </div>
  </div>
  <!-- --- modal end --- -->




  <script src="./_support.js"></script>
</body>
<script>
 window.onload = function () {
  dragUi();
  getIpAddressAndConnectWs();
}

function convertMilliseconds(milliseconds) {
  // if its not number then return milliseconds
  if (isNaN(milliseconds)) {
    return milliseconds;
  }
  if (milliseconds >= 60000) {
    // Convert to minutes
    return (milliseconds / 60000).toFixed(2) + " m";
  } else if (milliseconds >= 1000) {
    // Convert to seconds
    return (milliseconds / 1000).toFixed(2) + " s";
  } else {
    // Display milliseconds
    return milliseconds + " ms";
  }
}

function getTimeFromTimestamp(dateString) {
  var dateObject = new Date(dateString);
  var localTime = dateObject.toLocaleTimeString();
  var milliseconds = dateObject.getMilliseconds();
  localTime = localTime + "." + milliseconds;
  return localTime;
}
// add or update the row in the table
var selectedRowIntId = null;

function addOrUpdateApiRow(data) {
  const { request, response, id, type } = data;
  const { uri, method, timestamp } = request;
  const { statusCode = "_", duration = "Pending" } = response;
  let newNode = document.createElement('tr');

  newNode.className = 'api_row';
  newNode.id = "api_row_" + id;
  // if type is request then add new row else update the row
  if (type === 'response') {
    newNode = document.getElementById("api_row_" + id);
  }
  // adding onclick event to the row
  newNode.onclick = function () {
    console.log('clicked');
    renderRightSideContent(data);
    handelModelOpenIfMobile();
    
  }
  // if the row is selected then render the overview table with the updated data automatically
  if (selectedRowIntId === id) {
    renderRightSideContent(data);
  }
  var style = '';
  if(statusCode >=400){
    style = 'color:#FFB4AB';
  }

  const rowHtml = `
              <td>${method}</td>
              <td>${uri}</td>
              <td style="${style}">${statusCode}</td>
              <td>${convertMilliseconds(duration)}</td>
              <td>${getTimeFromTimestamp(timestamp)}</td>
  `;
  newNode.innerHTML = rowHtml;
  const table = document.getElementById('api_body');
  table.appendChild(newNode);
}


function listenToWebsocket(uri) {
  // Establishing a WebSocket connection
  const socket = new WebSocket('ws://'+uri);

  // Listening to connection open event
  socket.addEventListener('open', (event) => {
    console.log('WebSocket connection opened:', event);
  });

  // Listening to connection error event
  socket.addEventListener('error', (error) => {
    console.error('WebSocket error:', error);
  });

  // Listening to connection close event
  socket.addEventListener('close', (event) => {
    console.log('WebSocket connection closed:', event);
  });

  // Listening to incoming messages
  socket.addEventListener('message', (event) => {
    const data = JSON.parse(event.data);
    console.log('Received message:', data);
    addOrUpdateApiRow(data);
    // handleNewReuqest(data);
    // Handle the incoming data as needed
  });

  // Sending a sample message
  const sendMessage = () => {
    const message = { type: 'chat', content: 'Hello, WebSocket!' };
    socket.send(JSON.stringify(message));
  };
}

function handleNewReuqest(data) {
  const apiBox = document.getElementById('api-list-box');
  const newNode = document.createElement('div');
  const { request } = data;
  const { uri, method } = request;
  newNode.innerHTML = `<div class="api-list-item">${method} ${uri}</div>`;
  apiBox.appendChild(newNode);
}


function dragUi() {
  var dragger = document.querySelector('.content_dragger');
  var left = document.querySelector('.content_left');
  var right = document.querySelector('.content_right');
  var isDragging = false;

  const screenWidth = window.screen.availWidth;
  const screenHeight = window.screen.availHeight;

  const isMobile = screenWidth < 768;

  left.style.height = '100%';
  right.style.height = '100%';
  if (isMobile) {
    dragger.style.display = 'none';
    left.style.width = '100%';
    right.style.display = 'none';
    return;
  }

  left.style.width = screenWidth / 2 + 'px';
  right.style.width = screenWidth / 2 + 'px';


  dragger.addEventListener('mousedown', function (e) {
    isDragging = true;
  });
  document.addEventListener('mousemove', function (e) {
    if (!isDragging) return;
    const screenWidth = window.screen.availWidth;
    var x = e.clientX;
    var rect = dragger.getBoundingClientRect();
    var leftWidth = x;
    left.style.width = leftWidth + 'px';
    right.style.width = (screenWidth - leftWidth) + 'px';
  });

  document.addEventListener('mouseup', function (e) {
    isDragging = false;
  });
}

// --- tab ----
window.showTab = function (tabId) {
  // Hide all tab contents
  var tabContents = document.querySelectorAll('.tab-content');
  var tabList = document.querySelectorAll('.tab');
  tabList.forEach(function (tab) {
    tab.children[0].classList.remove('active');
  });
  tabContents.forEach(function (tabContent) {
    tabContent.classList.remove('active');
  });

  // Show the selected tab content
  tabList[tabId].children[0].classList.add('active')

  var selectedTab = tabContents[tabId];
  if (selectedTab) {
    selectedTab.classList.add('active');

    // Scroll to the selected tab with smooth animation
    selectedTab.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

// render the right side content

function renderRightSideContent(data) {
  selectedRowIntId = data.id;
  renderOverviewTable(data);
  renderHeaders(data);
  renderResponseBody(data);
  renderRequest(data);
  document.getElementById('copy-container').style.display = 'block';
  document.getElementById('curl_text').innerHTML = createCurlCommand(data);
}

// overview table render
function renderOverviewTable(data) {
  const { request, response, id, type } = data;
  const { uri, method, timestamp } = request;
  const { statusCode = "_", duration = "Pending" } = response;
  const htmlString = `
      <tbody style="border: none;" >
                    <tr style="border: none;">
                      <td class="overview_view_table_td">Request uri: </td>
                      <td class="overview_view_table_td">${uri}</td>
                    </tr>
                    <tr>
                      <td class="overview_view_table_td">Method</td>
                      <td class="overview_view_table_td">${method}</td>
                    </tr>
                    <tr>
                      <td class="overview_view_table_td">Status</td>
                      <td class="overview_view_table_td">${statusCode}</td>
                    </tr>
                    <tr>
                      <td class="overview_view_table_td">Duration</td>
                      <td class="overview_view_table_td">${convertMilliseconds(duration)}</td>
                    </tr>
                    <tr>
                      <td class="overview_view_table_td">Timestamp</td>
                      <td class="overview_view_table_td">${getTimeFromTimestamp(timestamp)}</td>
                  </tbody>
      `;
  document.getElementById('overview_table').innerHTML = htmlString;
}

// render headers section
const renderSpecificHeader = (headers) => {
  if (!headers) {
    return '';
  }
  const content = Object.keys(headers).map((key) => {
    return `<tr >
    <td class="overview_view_table_td">${key}</td>
    <td class="overview_view_table_td">${headers[key]}</td>
    </tr>`;
  });
  return `<table style="border: none;">
        <tbody>
          ${content.join('')}
        </tbody>
      </table>`;

};

function renderHeaders(data) {
  const { request, response, id, type } = data;
  const { headers: requestHeaders } = request;
  const { headers: responseHeaders } = response;
  document.getElementById('response-header-body').innerHTML = renderSpecificHeader(responseHeaders);
  document.getElementById('request-header-body').innerHTML = renderSpecificHeader(requestHeaders);
}


function renderRequest(data) {
  const { request, response, id, type } = data;
  const { data: requestData } = request;
  const tab3 = document.getElementById('tab3');
  tab3.innerHTML = '';
  if (requestData) {
    if (requestData['type'] === 'form-data') {
      console.log(requestData);
      tab3.innerHTML = requestData['result'].replaceAll("\n", "<br>");
    } else {
      var formatter = new JSONFormatter(requestData, 1, { theme: 'dark' });
      tab3.appendChild(formatter.render());
    }
  }
}

function renderResponseBody(dataObj) {
  const { response } = dataObj;
  const { data } = response;
  const tab4 = document.getElementById('tab4');
  tab4.innerHTML = '';
  if (data) {
    if (typeof data === 'object') {
      var formatter = new JSONFormatter(data, 1, { theme: 'dark' });
      let newNode = document.createElement('div');
      newNode.innerHTML = `hello athul`;
      tab4.appendChild(formatter.render());
    } else {
      tab4.innerHTML = data;
    }
  }
}

// function createCurlCommand(data) {
//   const { request, response, id, type } = data;
//   const { uri, method, headers, data: requestData } = request;
//   const { data: responseData } = response;
//   const headerString = Object.keys(headers).map((key) => {
//     return `-H "${key}: ${headers[key]}"`;
//   }).join(' ');
//   var bodyString = '';
//   if (requestData) {
//     if (requestData['type'] === 'form-data') {
//       bodyString += ` --form`;
//       bodyString = ` '${requestData['result']}'`;
//     }else{
//       bodyString = `-d '${JSON.stringify(requestData)}'`;
//     }
//   }


//   const curlCommand = `curl -X ${method} ${uri} ${headerString} ${bodyString}`;
//   return curlCommand;
// }

function createCurlCommand(data) {
  const { request, response, id, type } = data;
  const { uri, method, headers, data: requestData } = request;
  const { data: responseData } = response;

  //   curl --location --request POST '
  // https://stage.medisensehealthcare.com:4003/api/v1/auth/user/partnerEmailLogin'
  // \
  // --header 'device_id: android:emu64a:UPB2.230407.019' \
  // --header 'user-agent: Dart/3.2 (dart:io)' \
  // --header 'content-type: application/json' \
  // --header 'accept-encoding: gzip' \
  // --header 'content-length: 54' \
  // --header 'host: stage.medisensehealthcare.com:4003' \
  // --data-raw '{"email":"medical@medisense.me","password":"urbvgw3q"}'

  const headerString = Object.keys(headers).map((key) => {
    return `\n--header '${key}: ${headers[key]}'`;
  }).join(' ');

  var bodyString = '\n';
  if (requestData) {
    if (requestData['type'] === 'form-data') {
      bodyString += requestData['curlStr'];
    } else {
      bodyString = `--data-raw '${JSON.stringify(requestData)}'`;
    }
  }

  const curlCommand = `curl -X ${method} ${uri} ${headerString} ${bodyString}`;
  return curlCommand;

}

const copyToClipboard = async (id) => {
  try {
    const element = document.getElementById(id);
    await navigator.clipboard.writeText(element.textContent);
    console.log("Text copied to clipboard!");
    // Optional: Display a success message to the user
  } catch (error) {
    console.error("Failed to copy to clipboard:", error);
    // Optional: Display an error message to the user
  }
};

function handelModelOpenIfMobile() {
  const screenWidth = window.screen.availWidth;
  if (screenWidth < 768) {
    var right = document.querySelector('.content_right');
    // document.getElementById('modal-content-id').innerHTML='sghfgbdhshbg hdsfbghdsfj<br> sdfno';
    right.style.display = 'block';
    document.getElementById('modal-content-id').appendChild(right);
    
    $('#myModal').modal('show')
  }
}

function closeModal() {
  $('#myModal').modal('hide')
}

function closeNotification() {
  document.getElementById('notification').style.display = 'none';
}

function getIpAddressAndConnectWs(){
  const hostname = window.location.hostname;
  const host = window.location.host;
  const url=host="/ip";
  fetch(url).then((res)=>res.json()).then((data)=>{
    document.getElementById('ip_address').innerHTML = data.ip;
    if(hostname === 'localhost'){
      document.getElementById('notification').style.display = 'block';
    }
    listenToWebsocket(hostname+":8001");

  });
}
</script>
</html>